(()=>{"use strict";const e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",r=["1-0","0-1","1/2-1/2","*"],t={b:[16,32,17,15],w:[-16,-32,-17,-15]},n={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},a=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],o=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],i={p:0,n:1,b:2,r:3,q:4,k:5},s={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},l={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},u={w:[{square:l.a1,flag:s.QSIDE_CASTLE},{square:l.h1,flag:s.KSIDE_CASTLE}],b:[{square:l.a8,flag:s.QSIDE_CASTLE},{square:l.h8,flag:s.KSIDE_CASTLE}]};function f(e){var r=e.charAt(0);if(r>="a"&&r<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return A}return"o"===(r=r.toLowerCase())?C:r}function c(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function h(e){return e>>4}function p(e){return 15&e}function g(e){var r=p(e),t=h(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(t,t+1)}function v(e){return e===b?y:b}function m(e){var r=e instanceof Array?[]:{};for(var t in e)r[t]="object"==typeof t?m(e[t]):e[t];return r}function d(e){return e.replace(/^\s+|\s+$/g,"")}const y="b",b="w",E=-1,A="p",w="b",C="k",_=(function(){for(var e=[],r=l.a8;r<=l.h1;r++)136&r?r+=7:e.push(g(r))}(),{NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"}),S=function(S){var I=new Array(128),P={w:E,b:E},k=b,R={w:0,b:0},T=E,M=0,L=1,D=[],N={},O={};function q(e){void 0===e&&(e=!1),I=new Array(128),P={w:E,b:E},k=b,R={w:0,b:0},T=E,M=0,L=1,D=[],e||(N={}),O={},j(F())}function x(){for(var e=[],r={},t=function(e){e in O&&(r[e]=O[e])};D.length>0;)e.push(ne());for(t(F());e.length>0;)te(e.pop()),t(F());O=r}function Q(){U(e)}function U(e,r){void 0===r&&(r=!1);var t=e.split(/\s+/),n=t[0],a=0;if(!K(e).valid)return!1;q(r);for(var o=0;o<n.length;o++){var i=n.charAt(o);if("/"===i)a+=8;else if(-1!=="0123456789".indexOf(i))a+=parseInt(i,10);else{var u=i<"a"?b:y;z({type:i.toLowerCase(),color:u},g(a)),a++}}return k=t[1],t[2].indexOf("K")>-1&&(R.w|=s.KSIDE_CASTLE),t[2].indexOf("Q")>-1&&(R.w|=s.QSIDE_CASTLE),t[2].indexOf("k")>-1&&(R.b|=s.KSIDE_CASTLE),t[2].indexOf("q")>-1&&(R.b|=s.QSIDE_CASTLE),T="-"===t[3]?E:l[t[3]],M=parseInt(t[4],10),L=parseInt(t[5],10),j(F()),!0}function K(e){var r="No errors.",t="FEN string must contain six space-delimited fields.",n="6th field (move number) must be a positive integer.",a="5th field (half move counter) must be a non-negative integer.",o="4th field (en-passant square) is invalid.",i="3rd field (castling availability) is invalid.",s="2nd field (side to move) is invalid.",l="1st field (piece positions) does not contain 8 '/'-delimited rows.",u="1st field (piece positions) is invalid [consecutive numbers].",f="1st field (piece positions) is invalid [invalid piece].",c="1st field (piece positions) is invalid [row too large].",h="Illegal en-passant square",p=e.split(/\s+/);if(6!==p.length)return{valid:!1,error_number:1,error:t};if(isNaN(parseInt(p[5]))||parseInt(p[5],10)<=0)return{valid:!1,error_number:2,error:n};if(isNaN(parseInt(p[4]))||parseInt(p[4],10)<0)return{valid:!1,error_number:3,error:a};if(!/^(-|[abcdefgh][36])$/.test(p[3]))return{valid:!1,error_number:4,error:o};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(p[2]))return{valid:!1,error_number:5,error:i};if(!/^(w|b)$/.test(p[1]))return{valid:!1,error_number:6,error:s};var g=p[0].split("/");if(8!==g.length)return{valid:!1,error_number:7,error:l};for(var v=0;v<g.length;v++){for(var m=0,d=!1,y=0;y<g[v].length;y++)if(isNaN(g[v][y])){if(!/^[prnbqkPRNBQK]$/.test(g[v][y]))return{valid:!1,error_number:9,error:f};m+=1,d=!1}else{if(d)return{valid:!1,error_number:8,error:u};m+=parseInt(g[v][y],10),d=!0}if(8!==m)return{valid:!1,error_number:10,error:c}}return"3"==p[3][1]&&"w"==p[1]||"6"==p[3][1]&&"b"==p[1]?{valid:!1,error_number:11,error:h}:{valid:!0,error_number:0,error:r}}function F(){for(var e=0,r="",t=l.a8;t<=l.h1;t++){if(null==I[t])e++;else{e>0&&(r+=e,e=0);var n=I[t].color,a=I[t].type;r+=n===b?a.toUpperCase():a.toLowerCase()}t+1&136&&(e>0&&(r+=e),t!==l.h1&&(r+="/"),e=0,t+=8)}var o="";R[b]&s.KSIDE_CASTLE&&(o+="K"),R[b]&s.QSIDE_CASTLE&&(o+="Q"),R[y]&s.KSIDE_CASTLE&&(o+="k"),R[y]&s.QSIDE_CASTLE&&(o+="q"),o=o||"-";var i=T===E?"-":g(T);return[r,k,o,i,M,L].join(" ")}function $(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(N[e[r]]=e[r+1]);return N}function j(r){D.length>0||(r!==e?(N.SetUp="1",N.FEN=r):(delete N.SetUp,delete N.FEN))}function B(e){var r=I[l[e]];return r?{type:r.type,color:r.color}:null}function z(e,r){if(!("type"in e)||!("color"in e))return!1;if(-1==="pnbrqkPNBRQK".indexOf(e.type.toLowerCase()))return!1;if(!(r in l))return!1;var t=l[r];return(e.type!=C||P[e.color]==E||P[e.color]==t)&&(I[t]={type:e.type,color:e.color},e.type===C&&(P[e.color]=t),j(F()),!0)}function G(e,r,t,n,a){var o={color:k,from:r,to:t,flags:n,piece:e[r].type};return a&&(o.flags|=s.PROMOTION,o.promotion=a),e[t]?o.captured=e[t].type:n&s.EP_CAPTURE&&(o.captured=A),o}function W(e){function r(e,r,t,n,a){if(e[t].type!==A||0!==h(n)&&7!==h(n))r.push(G(e,t,n,a));else for(var o=["q","r",w,"n"],i=0,s=o.length;i<s;i++)r.push(G(e,t,n,a,o[i]))}var a=[],o=k,i=v(o),u={b:1,w:6},f=l.a8,c=l.h1,p=!1,g=void 0===e||!("legal"in e)||e.legal,m=void 0===e||!("piece"in e)||"string"!=typeof e.piece||e.piece.toLowerCase();if(void 0!==e&&"square"in e){if(!(e.square in l))return[];f=c=l[e.square],p=!0}for(var d=f;d<=c;d++)if(136&d)d+=7;else{var y=I[d];if(null!=y&&y.color===o)if(y.type!==A||!0!==m&&m!==A){if(!0===m||m===y.type)for(var b=0,E=n[y.type].length;b<E;b++){var _=n[y.type][b];for(S=d;!(136&(S+=_));){if(null!=I[S]){if(I[S].color===o)break;r(I,a,d,S,s.CAPTURE);break}if(r(I,a,d,S,s.NORMAL),"n"===y.type||"k"===y.type)break}}}else{var S=d+t[o][0];if(null==I[S]){r(I,a,d,S,s.NORMAL);var S=d+t[o][1];u[o]===h(d)&&null==I[S]&&r(I,a,d,S,s.BIG_PAWN)}for(b=2;b<4;b++){136&(S=d+t[o][b])||(null!=I[S]&&I[S].color===i?r(I,a,d,S,s.CAPTURE):S===T&&r(I,a,d,T,s.EP_CAPTURE))}}}if(!(!0!==m&&m!==C||p&&c!==P[o])){if(R[o]&s.KSIDE_CASTLE){var M=(L=P[o])+2;null!=I[L+1]||null!=I[M]||Z(i,P[o])||Z(i,L+1)||Z(i,M)||r(I,a,P[o],M,s.KSIDE_CASTLE)}if(R[o]&s.QSIDE_CASTLE){var L;M=(L=P[o])-2;null!=I[L-1]||null!=I[L-2]||null!=I[L-3]||Z(i,P[o])||Z(i,L-1)||Z(i,M)||r(I,a,P[o],M,s.QSIDE_CASTLE)}}if(!g)return a;var D=[];for(d=0,E=a.length;d<E;d++)te(a[d]),J(o)||D.push(a[d]),ne();return D}function H(e,r){var t="";if(e.flags&s.KSIDE_CASTLE)t="O-O";else if(e.flags&s.QSIDE_CASTLE)t="O-O-O";else{if(e.piece!==A){var n=function(e,r){for(var t=e.from,n=e.to,a=e.piece,o=0,i=0,s=0,l=0,u=r.length;l<u;l++){var f=r[l].from,c=r[l].to;a===r[l].piece&&t!==f&&n===c&&(o++,h(t)===h(f)&&i++,p(t)===p(f)&&s++)}return o>0?i>0&&s>0?g(t):s>0?g(t).charAt(1):g(t).charAt(0):""}(e,r);t+=e.piece.toUpperCase()+n}e.flags&(s.CAPTURE|s.EP_CAPTURE)&&(e.piece===A&&(t+=g(e.from)[0]),t+="x"),t+=g(e.to),e.flags&s.PROMOTION&&(t+="="+e.promotion.toUpperCase())}return te(e),V()&&(X()?t+="#":t+="+"),ne(),t}function Z(e,r){for(var t=l.a8;t<=l.h1;t++)if(136&t)t+=7;else if(null!=I[t]&&I[t].color===e){var n=I[t],s=t-r,u=s+119;if(a[u]&1<<i[n.type]){if(n.type===A){if(s>0){if(n.color===b)return!0}else if(n.color===y)return!0;continue}if("n"===n.type||"k"===n.type)return!0;for(var f=o[u],c=t+f,h=!1;c!==r;){if(null!=I[c]){h=!0;break}c+=f}if(!h)return!0}}return!1}function J(e){return Z(v(e),P[e])}function V(){return J(k)}function X(){return V()&&0===W().length}function Y(){return!V()&&0===W().length}function ee(){for(var e={},r=[],t=0,n=0,a=l.a8;a<=l.h1;a++)if(n=(n+1)%2,136&a)a+=7;else{var o=I[a];o&&(e[o.type]=o.type in e?e[o.type]+1:1,o.type===w&&r.push(n),t++)}if(2===t)return!0;if(3===t&&(1===e[w]||1===e.n))return!0;if(t===e[w]+2){var i=0,s=r.length;for(a=0;a<s;a++)i+=r[a];if(0===i||i===s)return!0}return!1}function re(){for(var e=[],r={},t=!1;;){var n=ne();if(!n)break;e.push(n)}for(;;){var a=F().split(" ").slice(0,4).join(" ");if(r[a]=a in r?r[a]+1:1,r[a]>=3&&(t=!0),!e.length)break;te(e.pop())}return t}function te(e){var r=k,t=v(r);if(function(e){D.push({move:e,kings:{b:P.b,w:P.w},turn:k,castling:{b:R.b,w:R.w},ep_square:T,half_moves:M,move_number:L})}(e),I[e.to]=I[e.from],I[e.from]=null,e.flags&s.EP_CAPTURE&&(k===y?I[e.to-16]=null:I[e.to+16]=null),e.flags&s.PROMOTION&&(I[e.to]={type:e.promotion,color:r}),I[e.to].type===C){if(P[I[e.to].color]=e.to,e.flags&s.KSIDE_CASTLE){var n=e.to-1,a=e.to+1;I[n]=I[a],I[a]=null}else if(e.flags&s.QSIDE_CASTLE){n=e.to+1,a=e.to-2;I[n]=I[a],I[a]=null}R[r]=""}if(R[r])for(var o=0,i=u[r].length;o<i;o++)if(e.from===u[r][o].square&&R[r]&u[r][o].flag){R[r]^=u[r][o].flag;break}if(R[t])for(o=0,i=u[t].length;o<i;o++)if(e.to===u[t][o].square&&R[t]&u[t][o].flag){R[t]^=u[t][o].flag;break}T=e.flags&s.BIG_PAWN?"b"===k?e.to-16:e.to+16:E,e.piece===A||e.flags&(s.CAPTURE|s.EP_CAPTURE)?M=0:M++,k===y&&L++,k=v(k)}function ne(){var e=D.pop();if(null==e)return null;var r=e.move;P=e.kings,k=e.turn,R=e.castling,T=e.ep_square,M=e.half_moves,L=e.move_number;var t,n,a=k,o=v(k);if(I[r.from]=I[r.to],I[r.from].type=r.piece,I[r.to]=null,r.flags&s.CAPTURE)I[r.to]={type:r.captured,color:o};else if(r.flags&s.EP_CAPTURE){var i;i=a===y?r.to-16:r.to+16,I[i]={type:A,color:o}}r.flags&(s.KSIDE_CASTLE|s.QSIDE_CASTLE)&&(r.flags&s.KSIDE_CASTLE?(t=r.to+1,n=r.to-1):r.flags&s.QSIDE_CASTLE&&(t=r.to-2,n=r.to+1),I[t]=I[n],I[n]=null);return r}function ae(e,r){for(var t=c(e),n=0;n<2;n++){if(1==n){if(!r)return null;var a=!1;if(h=t.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/)){var o=h[1],i=h[2],s=h[3],u=h[4];1==i.length&&(a=!0)}else{var h;if(h=t.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/)){o=h[1],i=h[2],s=h[3],u=h[4];if(1==i.length)a=!0}}}for(var p=f(t),v=W({legal:!0,piece:o||p}),m=0,d=v.length;m<d;m++)switch(n){case 0:if(t===c(H(v[m],v)))return v[m];break;case 1:if(h){if(!(o&&o.toLowerCase()!=v[m].piece||l[i]!=v[m].from||l[s]!=v[m].to||u&&u.toLowerCase()!=v[m].promotion))return v[m];if(a){var y=g(v[m].from);if(!(o&&o.toLowerCase()!=v[m].piece||l[s]!=v[m].to||i!=y[0]&&i!=y[1]||u&&u.toLowerCase()!=v[m].promotion))return v[m]}}}}return null}function oe(e){var r=m(e);r.san=H(r,W({legal:!0})),r.to=g(r.to),r.from=g(r.from);var t="";for(var n in s)s[n]&r.flags&&(t+=_[n]);return r.flags=t,r}function ie(e){for(var r=W({legal:!1}),t=0,n=k,a=0,o=r.length;a<o;a++){if(te(r[a]),!J(n))if(e-1>0)t+=ie(e-1);else t++;ne()}return t}return U(void 0===S?e:S),{load:function(e){return U(e)},reset:function(){return Q()},swapTurn:function(){this.turn==b?this.turn=y:this.turn=b},moves:function(e){for(var r=W(e),t=[],n=0,a=r.length;n<a;n++)void 0!==e&&"verbose"in e&&e.verbose?t.push(oe(r[n])):t.push(H(r[n],W({legal:!0})));return t},in_check:function(){return V()},in_checkmate:function(){return X()},in_stalemate:function(){return Y()},in_draw:function(){return M>=100||Y()||ee()||re()},insufficient_material:function(){return ee()},in_threefold_repetition:function(){return re()},game_over:function(){return M>=100||X()||Y()||ee()||re()},validate_fen:function(e){return K(e)},fen:function(){return F()},board:function(){for(var e=[],r=[],t=l.a8;t<=l.h1;t++)null==I[t]?r.push(null):r.push({square:g(t),type:I[t].type,color:I[t].color}),t+1&136&&(e.push(r),r=[],t+=8);return e},pgn:function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",t="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,n=[],a=!1;for(var o in N)n.push("["+o+' "'+N[o]+'"]'+r),a=!0;a&&D.length&&n.push(r);for(var i=function(e){var r=O[F()];void 0!==r&&(e=`${e}${e.length>0?" ":""}{${r}}`);return e},s=[];D.length>0;)s.push(ne());var l=[],u="";for(0===s.length&&l.push(i(""));s.length>0;){u=i(u);var f=s.pop();if(D.length||"b"!==f.color)"w"===f.color&&(u.length&&l.push(u),u=L+".");else{const e=`${L}. ...`;u=u?`${u} ${e}`:e}u=u+" "+H(f,W({legal:!0})),te(f)}if(u.length&&l.push(i(u)),void 0!==N.Result&&l.push(N.Result),0===t)return n.join("")+l.join(" ");var c=function(){return n.length>0&&" "===n[n.length-1]&&(n.pop(),!0)},h=function(e,a){for(var o of a.split(" "))if(o){if(e+o.length>t){for(;c();)e--;n.push(r),e=0}n.push(o),e+=o.length,n.push(" "),e++}return c()&&e--,e},p=0;for(o=0;o<l.length;o++)p+l[o].length>t&&l[o].includes("{")?p=h(p,l[o]):(p+l[o].length>t&&0!==o?(" "===n[n.length-1]&&n.pop(),n.push(r),p=0):0!==o&&(n.push(" "),p++),n.push(l[o]),p+=l[o].length);return n.join("")},load_pgn:function(e,t){var n=void 0!==t&&"sloppy"in t&&t.sloppy;function a(e){return e.replace(/\\/g,"\\")}e=e.trim();var o="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",i=new RegExp("^(\\[((?:"+a(o)+")|.)*\\])(?:\\s*"+a(o)+"){2}"),s=i.test(e)?i.exec(e)[1]:"";Q();var l=function(e,r){for(var t="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",n={},o=e.split(new RegExp(a(t))),i="",s="",l=0;l<o.length;l++){var u=/^\s*\[([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;i=o[l].replace(u,"$1"),s=o[l].replace(u,"$2"),d(i).length>0&&(n[i]=s)}return n}(s,t),u="";for(var f in l)"fen"===f.toLowerCase()&&(u=l[f]),$([f,l[f]]);if(n){if(u&&!U(u,!0))return!1}else if(!("1"!==l.SetUp||"FEN"in l&&U(l.FEN,!0)))return!1;for(var c=function(e){return`{${function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/\%/g,"").toLowerCase()})).join("")}((e=e.replace(new RegExp(a(o),"g")," ")).slice(1,e.length-1))}}`},h=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))}(e.slice(1,e.length-1))},p=e.replace(s,"").replace(new RegExp(`({[^}]*})+?|;([^${a(o)}]*)`,"g"),(function(e,r,t){return void 0!==r?c(r):" "+c(`{${t.slice(1)}}`)})).replace(new RegExp(a(o),"g")," "),g=/(\([^\(\)]+\))+?/g;g.test(p);)p=p.replace(g,"");var v=d(p=(p=(p=p.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));v=v.join(",").replace(/,,+/g,",").split(",");for(var m="",y="",b=0;b<v.length;b++){var E=h(v[b]);if(void 0===E)if(null==(m=ae(v[b],n))){if(!(r.indexOf(v[b])>-1))return!1;y=v[b]}else y="",te(m);else O[F()]=E}return y&&Object.keys(N).length&&!N.Result&&$(["Result",y]),!0},header:function(){return $(arguments)},turn:function(){return k},move:function(e,r){var t=void 0!==r&&"sloppy"in r&&r.sloppy,n=null;if("string"==typeof e)n=ae(e,t);else if("object"==typeof e)for(var a=W(),o=0,i=a.length;o<i;o++)if(e.from===g(a[o].from)&&e.to===g(a[o].to)&&(!("promotion"in a[o])||e.promotion===a[o].promotion)){n=a[o];break}if(!n)return null;var s=oe(n);return te(n),s},undo:function(){var e=ne();return e?oe(e):null},clear:function(){return q()},put:function(e,r){return z(e,r)},get:function(e){return B(e)},ascii(){for(var e="   +------------------------+\n",r=l.a8;r<=l.h1;r++){if(0===p(r)&&(e+=" "+"87654321"[h(r)]+" |"),null==I[r])e+=" . ";else{var t=I[r].type;e+=" "+(I[r].color===b?t.toUpperCase():t.toLowerCase())+" "}r+1&136&&(e+="|\n",r+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h"},remove:function(e){return function(e){var r=B(e);return I[l[e]]=null,r&&r.type===C&&(P[r.color]=E),j(F()),r}(e)},perft:function(e){return ie(e)},square_color:function(e){if(e in l){var r=l[e];return(h(r)+p(r))%2==0?"light":"dark"}return null},history:function(e){for(var r=[],t=[],n=(void 0!==e&&"verbose"in e&&e.verbose);D.length>0;)r.push(ne());for(;r.length>0;){var a=r.pop();n?t.push(oe(a)):t.push(H(a,W({legal:!0}))),te(a)}return t},get_comment:function(){return O[F()]},set_comment:function(e){O[F()]=e.replace("{","[").replace("}","]")},delete_comment:function(){var e=O[F()];return delete O[F()],e},get_comments:function(){return x(),Object.keys(O).map((function(e){return{fen:e,comment:O[e]}}))},delete_comments:function(){return x(),Object.keys(O).map((function(e){var r=O[e];return delete O[e],{fen:e,comment:r}}))}}};const I={q:9,r:5,b:3,n:3,p:1,k:0};function P(e){return String.fromCharCode(97+e%8)+(8-Math.floor(e/8))}function k(e,r,t){if(t!=e.turn()){const r=T(e.fen());e=S(r)}let n=0;const a=e.get(r);if(null==a)return 0;if(a.color==t)return 0;const[o,i]=function(e,r,t){const n=e.get(r);if(n&&n.color===t)return[-1,-1];const a=function(e,r,t){const n=e.moves({verbose:!0});var a=[];for(const e of n)e.to==t&&a.push(e.from);return a}(e,0,r);let o=null,i=-1;for(const r of a){const t=e.get(r).type;(null===o||R(t)<R(o))&&(o=t,i=r)}return[o,i]}(e,r,t),s=a.type;if(o&&s){!function(e,r){e.move({from:r.substring(0,2),to:r.substring(2,4)})}(e,`${i}${r}`),n=Math.max(0,R(s)-k(e,r,function(e){return"w"===e?"b":"w"}(t))),function(e){e.undo()}(e)}return n}function R(e){const r=e.toLowerCase();return I[r]}function T(e){var r=e.split(" ");return"w"==r[1]?r[1]="b":r[1]="w",e=r.join(" ")}function M(e){return e.split(" ")[1]}function L(e,r){let t=0;M(e)!=r&&(e=T(e));for(let n=0;n<64;n++)t=Math.max(t,D(e,P(n),r));return t}function D(e,r,t){return k(S(e),r,t)}function N(e,r){const t=S();t.load(e);let n=0;for(let e=0;e<64;e++){const a=P(e),o=t.get(a);if(null!==o&&o.color===r){n+=R(o.type)}}return n}function O(e,r,t,n){if(function(e){const r=S(e);return!(!r.in_check()||1!=r.moves.length)}(r))return!1;const a=M(e),o=N(e,a)-N(t,a),i=L(t,a),s=L(e,a);return D(r,n.substring(0,2),a)+1+o<D(t,n.substring(2,4),a)||(o?0<i-s-o:1<i-s-o)}class q{constructor(){chrome.runtime.onMessage.addListener((e=>{if("MemoryHandlerSet"==e.type){var r=e.message.key,t=e.message.value;this.setData(r,t)}if("MemoryHandlerGet"==e.type){r=e.message;this.getData(r)}}))}async setData(e,r){var t={};t[e]=r,await chrome.storage.local.set(t),chrome.runtime.sendMessage({type:"MemoryHandler",status:"ok"})}async getData(e){var r=[e];return(await chrome.storage.local.get(r))[e]}}function x(e){return 50+50*(2/(1+Math.exp(-.00368208*e))-1)}new class{constructor(){this.gameAnalysis=[],this.analysisArray=[],this.stopped=!1,this.running=!1,this.waitingForStockfish=!1,this.memoryHandler=new q,this.stockfishReady=!1,this.moveQueue=[],this.analysisBlocked=!1,this.analyzedMoves=[],chrome.runtime.onMessage.addListener((e=>{"stockfishToAnalysis"==e.type&&this.sendEval(e.message),"analyzeMoves"==e.type&&this.analyzeMoveArray(e.message.moves,e.message.gameId,e.message.playerSide,e.message.playerElos),e.type,"stockfish"==e.type&&"readyok"==e.message&&(this.stockfishReady=!0)})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e&&e.url&&this.stopExtensionIfOnWebsite(e.url)}))})),chrome.tabs.onUpdated.addListener(((e,r,t)=>{t.active&&this.stopExtensionIfOnWebsite(t.url)})),this.analyzeMovesThread()}stopExtensionIfOnWebsite(e){this.gameId,this.gameId&&e!=this.gameId?(this.gameId,this.analysisBlocked=!0):(this.gameId,this.analysisBlocked=!1)}clearData(){this.gameAnalysis=[],this.analysisArray=[]}async hasDocument(){const e=await clients.matchAll({includeUncontrolled:!0,type:"window"});for(const r of e)if(r.url.endsWith("offscreen.html"))return!0;return!1}async waitUntilStockfishReady(){for(;0==this.stockfishReady;)chrome.runtime.sendMessage({type:"move array",message:"isready"}),await new Promise((e=>setTimeout(e,500)))}async setupStockfish(){await this.hasDocument()||await chrome.offscreen.createDocument({url:"./offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS||chrome.offscreen.Reason.IFRAME_SCRIPTING],justification:"need to spawn web worker for stockfish"})}async setupIfNeededAndSendMessage(e){await this.setupStockfish(),await this.waitUntilStockfishReady(e.gameId),this.stockfishReady=!1,chrome.runtime.sendMessage(e),await new Promise((e=>setTimeout(e,500)))}async analyzeMovesThread(){for(;;)if(await new Promise((e=>setTimeout(e,200))),!this.analysisBlocked&&this.moveQueue.length>0){var{fen:e,move:r,index:t}=this.moveQueue.shift();this.gameId,await this.setupIfNeededAndSendMessage({type:"move array",message:{fen:e,move:r,index:t,gameId:this.gameId}})}}async clearDataIfNewGame(e){if((await chrome.storage.local.get(["currentGameId"])).currentGameId!=e){this.gameId=e;try{await chrome.offscreen.closeDocument()}catch(e){}await this.setupStockfish(),this.analyzedMoves=[],this.moveQueue=[],this.gameAnalysis=[],this.analysisArray=[],this.totalMoveArray=[],this.totalFenArray=[],await chrome.storage.local.set({currentGameId:e}),await chrome.storage.local.set({analysisData:[]}),await chrome.storage.local.set({movearray:[]}),await chrome.storage.local.set({fenarray:[]}),await chrome.storage.local.set({analyzedFens:[]})}}returnNewMoves(e){const r=this.analyzedMoves,t=Array.from(e.slice(r.length));r.length,r.toString(),e.toString(),t.toString();for(const e of t)this.analyzedMoves.push(e);return t}async analyzeMoveArray(e,r,t,n=[-3,-3]){var a;await this.clearDataIfNewGame(r),this.playerSide=t,a=this.totalFenArray?this.totalFenArray.length:0,this.totalMoveArray=function(e){const r=new S;for(const t of e)r.move(t);var t=r.history({verbose:!0});return t.forEach(((e,r)=>{e.fromto=e.from+e.to})),t}(e),this.totalFenArray=function(e){const r=new S,t=[];t.push(r.fen());for(const n of e)r.move(n),t.push(r.fen());return t}(e),chrome.storage.local.set({moveArray:this.totalMoveArray}),chrome.storage.local.set({fenArray:this.totalFenArray}),chrome.storage.local.set({playerSide:this.playerSide}),chrome.storage.local.set({playerElos:n});for(let e=a;e<this.totalFenArray.length;e++)0==e?this.moveQueue.push({fen:this.totalFenArray[e],move:"",index:e}):this.moveQueue.push({fen:this.totalFenArray[e],move:this.totalMoveArray[e-1].fromto,index:e})}calculateMoveBrilliance(e,r){if(r<2)return"gray";const t=r%2,n=this.analysisArray[this.analysisArray.length-2],a=this.analysisArray[this.analysisArray.length-1],o=x(a[0].CPreal),i=x(n[0].CPreal);if(this.analysisArray,!(1 in n))return"gray";const s=(a[0].CPreal-n[0].CPreal)*(t?1:-1);if(this.analysisArray.length>2){const r=this.analysisArray[this.analysisArray.length-3];if(s>-75&&(Math.abs(a[0].CPreal)<75||1==t&&a[0].CPreal>0||0==t&&a[0].CPreal<0)&&O(r[0].FEN,n[0].FEN,a[0].FEN,e))return"brilliant"}if(e==n[0].move)return Math.abs(Math.abs(n[0].CPreal)-Math.abs(n[1].CPreal))>100?"great":"best";const l=(i-o)*(t?-1:1);return e==n[1].move&&Math.abs(Math.abs(n[0].CPreal)-Math.abs(n[1].CPreal))<100?"good":l<-30?"blunder":l<-15?"mistake":l<-10?"inaccuracy":"gray"}async sendEval(e){if(this.stopped)return;var r=e.gameId;if(e.FENstring,r!=this.gameId)return;var t=e.positionEvaluation,n=(e.FENstring,e.regularMove),a=e.moveIndex;const o={},i=t[0].CP;if("mate"==t[0].cpOrMate)if(1==t[0].isCheckmated)o.CP="M0",o.evaluation=49*-i,t[0].CPreal=2e3*-i;else{const e=i>0?1:-1;o.CP="M"+i.toString(),o.evaluation=49*e,t[0].CPreal=2e3*e}else{var s=50*(2/(1+Math.exp(-.004*i))-1);o.evaluation=s,o.CP=i,t[0].CPreal=i}this.analysisArray.push(t),o.moveRating=this.calculateMoveBrilliance(n,a),this.gameAnalysis.push(o),this.gameAnalysis,await chrome.storage.local.set({analyzedFens:this.analysisArray}),await chrome.storage.local.set({analysisData:this.gameAnalysis}),chrome.storage.local.get(["analysisData"]).then((e=>{e.analysisData}))}async stopAnalysis(){if(0!=this.running){for(this.stopped=!0;this.stopped;)await new Promise((e=>setTimeout(e,100)));this.clearData()}}}})();