(()=>{"use strict";const e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",r=["1-0","0-1","1/2-1/2","*"],t={b:[16,32,17,15],w:[-16,-32,-17,-15]},n={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},o=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],a=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],i={p:0,n:1,b:2,r:3,q:4,k:5},s={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},l={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},u={w:[{square:l.a1,flag:s.QSIDE_CASTLE},{square:l.h1,flag:s.KSIDE_CASTLE}],b:[{square:l.a8,flag:s.QSIDE_CASTLE},{square:l.h8,flag:s.KSIDE_CASTLE}]};function f(e){var r=e.charAt(0);if(r>="a"&&r<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return A}return"o"===(r=r.toLowerCase())?C:r}function c(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function h(e){return e>>4}function p(e){return 15&e}function g(e){var r=p(e),t=h(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(t,t+1)}function v(e){return e===b?y:b}function m(e){var r=e instanceof Array?[]:{};for(var t in e)r[t]="object"==typeof t?m(e[t]):e[t];return r}function d(e){return e.replace(/^\s+|\s+$/g,"")}const y="b",b="w",E=-1,A="p",w="b",C="k",I=(function(){for(var e=[],r=l.a8;r<=l.h1;r++)136&r?r+=7:e.push(g(r))}(),{NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"}),S=function(S){var _=new Array(128),P={w:E,b:E},k=b,R={w:0,b:0},T=E,M=0,L=1,D=[],N={},O={};function q(e){void 0===e&&(e=!1),_=new Array(128),P={w:E,b:E},k=b,R={w:0,b:0},T=E,M=0,L=1,D=[],e||(N={}),O={},j(F())}function x(){for(var e=[],r={},t=function(e){e in O&&(r[e]=O[e])};D.length>0;)e.push(ne());for(t(F());e.length>0;)te(e.pop()),t(F());O=r}function Q(){U(e)}function U(e,r){void 0===r&&(r=!1);var t=e.split(/\s+/),n=t[0],o=0;if(!K(e).valid)return!1;q(r);for(var a=0;a<n.length;a++){var i=n.charAt(a);if("/"===i)o+=8;else if(-1!=="0123456789".indexOf(i))o+=parseInt(i,10);else{var u=i<"a"?b:y;z({type:i.toLowerCase(),color:u},g(o)),o++}}return k=t[1],t[2].indexOf("K")>-1&&(R.w|=s.KSIDE_CASTLE),t[2].indexOf("Q")>-1&&(R.w|=s.QSIDE_CASTLE),t[2].indexOf("k")>-1&&(R.b|=s.KSIDE_CASTLE),t[2].indexOf("q")>-1&&(R.b|=s.QSIDE_CASTLE),T="-"===t[3]?E:l[t[3]],M=parseInt(t[4],10),L=parseInt(t[5],10),j(F()),!0}function K(e){var r=e.split(/\s+/);if(6!==r.length)return{valid:!1,error_number:1,error:"FEN string must contain six space-delimited fields."};if(isNaN(parseInt(r[5]))||parseInt(r[5],10)<=0)return{valid:!1,error_number:2,error:"6th field (move number) must be a positive integer."};if(isNaN(parseInt(r[4]))||parseInt(r[4],10)<0)return{valid:!1,error_number:3,error:"5th field (half move counter) must be a non-negative integer."};if(!/^(-|[abcdefgh][36])$/.test(r[3]))return{valid:!1,error_number:4,error:"4th field (en-passant square) is invalid."};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(r[2]))return{valid:!1,error_number:5,error:"3rd field (castling availability) is invalid."};if(!/^(w|b)$/.test(r[1]))return{valid:!1,error_number:6,error:"2nd field (side to move) is invalid."};var t=r[0].split("/");if(8!==t.length)return{valid:!1,error_number:7,error:"1st field (piece positions) does not contain 8 '/'-delimited rows."};for(var n=0;n<t.length;n++){for(var o=0,a=!1,i=0;i<t[n].length;i++)if(isNaN(t[n][i])){if(!/^[prnbqkPRNBQK]$/.test(t[n][i]))return{valid:!1,error_number:9,error:"1st field (piece positions) is invalid [invalid piece]."};o+=1,a=!1}else{if(a)return{valid:!1,error_number:8,error:"1st field (piece positions) is invalid [consecutive numbers]."};o+=parseInt(t[n][i],10),a=!0}if(8!==o)return{valid:!1,error_number:10,error:"1st field (piece positions) is invalid [row too large]."}}return"3"==r[3][1]&&"w"==r[1]||"6"==r[3][1]&&"b"==r[1]?{valid:!1,error_number:11,error:"Illegal en-passant square"}:{valid:!0,error_number:0,error:"No errors."}}function F(){for(var e=0,r="",t=l.a8;t<=l.h1;t++){if(null==_[t])e++;else{e>0&&(r+=e,e=0);var n=_[t].color,o=_[t].type;r+=n===b?o.toUpperCase():o.toLowerCase()}t+1&136&&(e>0&&(r+=e),t!==l.h1&&(r+="/"),e=0,t+=8)}var a="";R[b]&s.KSIDE_CASTLE&&(a+="K"),R[b]&s.QSIDE_CASTLE&&(a+="Q"),R[y]&s.KSIDE_CASTLE&&(a+="k"),R[y]&s.QSIDE_CASTLE&&(a+="q"),a=a||"-";var i=T===E?"-":g(T);return[r,k,a,i,M,L].join(" ")}function $(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(N[e[r]]=e[r+1]);return N}function j(r){D.length>0||(r!==e?(N.SetUp="1",N.FEN=r):(delete N.SetUp,delete N.FEN))}function B(e){var r=_[l[e]];return r?{type:r.type,color:r.color}:null}function z(e,r){if(!("type"in e)||!("color"in e))return!1;if(-1==="pnbrqkPNBRQK".indexOf(e.type.toLowerCase()))return!1;if(!(r in l))return!1;var t=l[r];return(e.type!=C||P[e.color]==E||P[e.color]==t)&&(_[t]={type:e.type,color:e.color},e.type===C&&(P[e.color]=t),j(F()),!0)}function G(e,r,t,n,o){var a={color:k,from:r,to:t,flags:n,piece:e[r].type};return o&&(a.flags|=s.PROMOTION,a.promotion=o),e[t]?a.captured=e[t].type:n&s.EP_CAPTURE&&(a.captured=A),a}function W(e){function r(e,r,t,n,o){if(e[t].type!==A||0!==h(n)&&7!==h(n))r.push(G(e,t,n,o));else for(var a=["q","r",w,"n"],i=0,s=a.length;i<s;i++)r.push(G(e,t,n,o,a[i]))}var o=[],a=k,i=v(a),u={b:1,w:6},f=l.a8,c=l.h1,p=!1,g=void 0===e||!("legal"in e)||e.legal,m=void 0===e||!("piece"in e)||"string"!=typeof e.piece||e.piece.toLowerCase();if(void 0!==e&&"square"in e){if(!(e.square in l))return[];f=c=l[e.square],p=!0}for(var d=f;d<=c;d++)if(136&d)d+=7;else{var y=_[d];if(null!=y&&y.color===a)if(y.type!==A||!0!==m&&m!==A){if(!0===m||m===y.type)for(var b=0,E=n[y.type].length;b<E;b++){var I=n[y.type][b];for(S=d;!(136&(S+=I));){if(null!=_[S]){if(_[S].color===a)break;r(_,o,d,S,s.CAPTURE);break}if(r(_,o,d,S,s.NORMAL),"n"===y.type||"k"===y.type)break}}}else{var S=d+t[a][0];if(null==_[S]){r(_,o,d,S,s.NORMAL);S=d+t[a][1];u[a]===h(d)&&null==_[S]&&r(_,o,d,S,s.BIG_PAWN)}for(b=2;b<4;b++)136&(S=d+t[a][b])||(null!=_[S]&&_[S].color===i?r(_,o,d,S,s.CAPTURE):S===T&&r(_,o,d,T,s.EP_CAPTURE))}}if(!(!0!==m&&m!==C||p&&c!==P[a])){if(R[a]&s.KSIDE_CASTLE){var M=(L=P[a])+2;null!=_[L+1]||null!=_[M]||V(i,P[a])||V(i,L+1)||V(i,M)||r(_,o,P[a],M,s.KSIDE_CASTLE)}var L;if(R[a]&s.QSIDE_CASTLE)M=(L=P[a])-2,null!=_[L-1]||null!=_[L-2]||null!=_[L-3]||V(i,P[a])||V(i,L-1)||V(i,M)||r(_,o,P[a],M,s.QSIDE_CASTLE)}if(!g)return o;var D=[];for(d=0,E=o.length;d<E;d++)te(o[d]),Z(a)||D.push(o[d]),ne();return D}function H(e,r){var t="";if(e.flags&s.KSIDE_CASTLE)t="O-O";else if(e.flags&s.QSIDE_CASTLE)t="O-O-O";else{if(e.piece!==A){var n=function(e,r){for(var t=e.from,n=e.to,o=e.piece,a=0,i=0,s=0,l=0,u=r.length;l<u;l++){var f=r[l].from,c=r[l].to;o===r[l].piece&&t!==f&&n===c&&(a++,h(t)===h(f)&&i++,p(t)===p(f)&&s++)}return a>0?i>0&&s>0?g(t):s>0?g(t).charAt(1):g(t).charAt(0):""}(e,r);t+=e.piece.toUpperCase()+n}e.flags&(s.CAPTURE|s.EP_CAPTURE)&&(e.piece===A&&(t+=g(e.from)[0]),t+="x"),t+=g(e.to),e.flags&s.PROMOTION&&(t+="="+e.promotion.toUpperCase())}return te(e),J()&&(X()?t+="#":t+="+"),ne(),t}function V(e,r){for(var t=l.a8;t<=l.h1;t++)if(136&t)t+=7;else if(null!=_[t]&&_[t].color===e){var n=_[t],s=t-r,u=s+119;if(o[u]&1<<i[n.type]){if(n.type===A){if(s>0){if(n.color===b)return!0}else if(n.color===y)return!0;continue}if("n"===n.type||"k"===n.type)return!0;for(var f=a[u],c=t+f,h=!1;c!==r;){if(null!=_[c]){h=!0;break}c+=f}if(!h)return!0}}return!1}function Z(e){return V(v(e),P[e])}function J(){return Z(k)}function X(){return J()&&0===W().length}function Y(){return!J()&&0===W().length}function ee(){for(var e={},r=[],t=0,n=0,o=l.a8;o<=l.h1;o++)if(n=(n+1)%2,136&o)o+=7;else{var a=_[o];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===w&&r.push(n),t++)}if(2===t)return!0;if(3===t&&(1===e[w]||1===e.n))return!0;if(t===e[w]+2){var i=0,s=r.length;for(o=0;o<s;o++)i+=r[o];if(0===i||i===s)return!0}return!1}function re(){for(var e=[],r={},t=!1;;){var n=ne();if(!n)break;e.push(n)}for(;;){var o=F().split(" ").slice(0,4).join(" ");if(r[o]=o in r?r[o]+1:1,r[o]>=3&&(t=!0),!e.length)break;te(e.pop())}return t}function te(e){var r=k,t=v(r);if(function(e){D.push({move:e,kings:{b:P.b,w:P.w},turn:k,castling:{b:R.b,w:R.w},ep_square:T,half_moves:M,move_number:L})}(e),_[e.to]=_[e.from],_[e.from]=null,e.flags&s.EP_CAPTURE&&(k===y?_[e.to-16]=null:_[e.to+16]=null),e.flags&s.PROMOTION&&(_[e.to]={type:e.promotion,color:r}),_[e.to].type===C){if(P[_[e.to].color]=e.to,e.flags&s.KSIDE_CASTLE){var n=e.to-1,o=e.to+1;_[n]=_[o],_[o]=null}else e.flags&s.QSIDE_CASTLE&&(n=e.to+1,o=e.to-2,_[n]=_[o],_[o]=null);R[r]=""}if(R[r])for(var a=0,i=u[r].length;a<i;a++)if(e.from===u[r][a].square&&R[r]&u[r][a].flag){R[r]^=u[r][a].flag;break}if(R[t])for(a=0,i=u[t].length;a<i;a++)if(e.to===u[t][a].square&&R[t]&u[t][a].flag){R[t]^=u[t][a].flag;break}T=e.flags&s.BIG_PAWN?"b"===k?e.to-16:e.to+16:E,e.piece===A||e.flags&(s.CAPTURE|s.EP_CAPTURE)?M=0:M++,k===y&&L++,k=v(k)}function ne(){var e=D.pop();if(null==e)return null;var r=e.move;P=e.kings,k=e.turn,R=e.castling,T=e.ep_square,M=e.half_moves,L=e.move_number;var t,n,o=k,a=v(k);if(_[r.from]=_[r.to],_[r.from].type=r.piece,_[r.to]=null,r.flags&s.CAPTURE)_[r.to]={type:r.captured,color:a};else if(r.flags&s.EP_CAPTURE){var i;i=o===y?r.to-16:r.to+16,_[i]={type:A,color:a}}return r.flags&(s.KSIDE_CASTLE|s.QSIDE_CASTLE)&&(r.flags&s.KSIDE_CASTLE?(t=r.to+1,n=r.to-1):r.flags&s.QSIDE_CASTLE&&(t=r.to-2,n=r.to+1),_[t]=_[n],_[n]=null),r}function oe(e,r){for(var t=c(e),n=0;n<2;n++){if(1==n){if(!r)return null;var o=!1;if(h=t.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/)){var a=h[1],i=h[2],s=h[3],u=h[4];1==i.length&&(o=!0)}else{var h;(h=t.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/))&&(a=h[1],i=h[2],s=h[3],u=h[4],1==i.length&&(o=!0))}}for(var p=f(t),v=W({legal:!0,piece:a||p}),m=0,d=v.length;m<d;m++)switch(n){case 0:if(t===c(H(v[m],v)))return v[m];break;case 1:if(h){if(!(a&&a.toLowerCase()!=v[m].piece||l[i]!=v[m].from||l[s]!=v[m].to||u&&u.toLowerCase()!=v[m].promotion))return v[m];if(o){var y=g(v[m].from);if(!(a&&a.toLowerCase()!=v[m].piece||l[s]!=v[m].to||i!=y[0]&&i!=y[1]||u&&u.toLowerCase()!=v[m].promotion))return v[m]}}}}return null}function ae(e){var r=m(e);r.san=H(r,W({legal:!0})),r.to=g(r.to),r.from=g(r.from);var t="";for(var n in s)s[n]&r.flags&&(t+=I[n]);return r.flags=t,r}function ie(e){for(var r=W({legal:!1}),t=0,n=k,o=0,a=r.length;o<a;o++)te(r[o]),Z(n)||(e-1>0?t+=ie(e-1):t++),ne();return t}return U(void 0===S?e:S),{load:function(e){return U(e)},reset:function(){return Q()},swapTurn:function(){this.turn==b?this.turn=y:this.turn=b},moves:function(e){for(var r=W(e),t=[],n=0,o=r.length;n<o;n++)void 0!==e&&"verbose"in e&&e.verbose?t.push(ae(r[n])):t.push(H(r[n],W({legal:!0})));return t},in_check:function(){return J()},in_checkmate:function(){return X()},in_stalemate:function(){return Y()},in_draw:function(){return M>=100||Y()||ee()||re()},insufficient_material:function(){return ee()},in_threefold_repetition:function(){return re()},game_over:function(){return M>=100||X()||Y()||ee()||re()},validate_fen:function(e){return K(e)},fen:function(){return F()},board:function(){for(var e=[],r=[],t=l.a8;t<=l.h1;t++)null==_[t]?r.push(null):r.push({square:g(t),type:_[t].type,color:_[t].color}),t+1&136&&(e.push(r),r=[],t+=8);return e},pgn:function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",t="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,n=[],o=!1;for(var a in N)n.push("["+a+' "'+N[a]+'"]'+r),o=!0;o&&D.length&&n.push(r);for(var i=function(e){var r=O[F()];return void 0!==r&&(e=`${e}${e.length>0?" ":""}{${r}}`),e},s=[];D.length>0;)s.push(ne());var l=[],u="";for(0===s.length&&l.push(i(""));s.length>0;){u=i(u);var f=s.pop();if(D.length||"b"!==f.color)"w"===f.color&&(u.length&&l.push(u),u=L+".");else{const e=`${L}. ...`;u=u?`${u} ${e}`:e}u=u+" "+H(f,W({legal:!0})),te(f)}if(u.length&&l.push(i(u)),void 0!==N.Result&&l.push(N.Result),0===t)return n.join("")+l.join(" ");var c=function(){return n.length>0&&" "===n[n.length-1]&&(n.pop(),!0)},h=function(e,o){for(var a of o.split(" "))if(a){if(e+a.length>t){for(;c();)e--;n.push(r),e=0}n.push(a),e+=a.length,n.push(" "),e++}return c()&&e--,e},p=0;for(a=0;a<l.length;a++)p+l[a].length>t&&l[a].includes("{")?p=h(p,l[a]):(p+l[a].length>t&&0!==a?(" "===n[n.length-1]&&n.pop(),n.push(r),p=0):0!==a&&(n.push(" "),p++),n.push(l[a]),p+=l[a].length);return n.join("")},load_pgn:function(e,t){var n=void 0!==t&&"sloppy"in t&&t.sloppy;function o(e){return e.replace(/\\/g,"\\")}e=e.trim();var a="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",i=new RegExp("^(\\[((?:"+o(a)+")|.)*\\])(?:\\s*"+o(a)+"){2}"),s=i.test(e)?i.exec(e)[1]:"";Q();var l=function(e,r){for(var t="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",n={},a=e.split(new RegExp(o(t))),i="",s="",l=0;l<a.length;l++){var u=/^\s*\[([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;i=a[l].replace(u,"$1"),s=a[l].replace(u,"$2"),d(i).length>0&&(n[i]=s)}return n}(s,t),u="";for(var f in l)"fen"===f.toLowerCase()&&(u=l[f]),$([f,l[f]]);if(n){if(u&&!U(u,!0))return!1}else if(!("1"!==l.SetUp||"FEN"in l&&U(l.FEN,!0)))return!1;for(var c=function(e){return`{${function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/\%/g,"").toLowerCase()})).join("")}((e=e.replace(new RegExp(o(a),"g")," ")).slice(1,e.length-1))}}`},h=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))}(e.slice(1,e.length-1))},p=e.replace(s,"").replace(new RegExp(`({[^}]*})+?|;([^${o(a)}]*)`,"g"),(function(e,r,t){return void 0!==r?c(r):" "+c(`{${t.slice(1)}}`)})).replace(new RegExp(o(a),"g")," "),g=/(\([^\(\)]+\))+?/g;g.test(p);)p=p.replace(g,"");var v=d(p=(p=(p=p.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));v=v.join(",").replace(/,,+/g,",").split(",");for(var m="",y="",b=0;b<v.length;b++){var E=h(v[b]);if(void 0===E)if(null==(m=oe(v[b],n))){if(!(r.indexOf(v[b])>-1))return!1;y=v[b]}else y="",te(m);else O[F()]=E}return y&&Object.keys(N).length&&!N.Result&&$(["Result",y]),!0},header:function(){return $(arguments)},turn:function(){return k},move:function(e,r){var t=void 0!==r&&"sloppy"in r&&r.sloppy,n=null;if("string"==typeof e)n=oe(e,t);else if("object"==typeof e)for(var o=W(),a=0,i=o.length;a<i;a++)if(e.from===g(o[a].from)&&e.to===g(o[a].to)&&(!("promotion"in o[a])||e.promotion===o[a].promotion)){n=o[a];break}if(!n)return null;var s=ae(n);return te(n),s},undo:function(){var e=ne();return e?ae(e):null},clear:function(){return q()},put:function(e,r){return z(e,r)},get:function(e){return B(e)},ascii(){for(var e="   +------------------------+\n",r=l.a8;r<=l.h1;r++){if(0===p(r)&&(e+=" "+"87654321"[h(r)]+" |"),null==_[r])e+=" . ";else{var t=_[r].type;e+=" "+(_[r].color===b?t.toUpperCase():t.toLowerCase())+" "}r+1&136&&(e+="|\n",r+=8)}return(e+="   +------------------------+\n")+"     a  b  c  d  e  f  g  h"},remove:function(e){return function(e){var r=B(e);return _[l[e]]=null,r&&r.type===C&&(P[r.color]=E),j(F()),r}(e)},perft:function(e){return ie(e)},square_color:function(e){if(e in l){var r=l[e];return(h(r)+p(r))%2==0?"light":"dark"}return null},history:function(e){for(var r=[],t=[],n=(void 0!==e&&"verbose"in e&&e.verbose);D.length>0;)r.push(ne());for(;r.length>0;){var o=r.pop();n?t.push(ae(o)):t.push(H(o,W({legal:!0}))),te(o)}return t},get_comment:function(){return O[F()]},set_comment:function(e){O[F()]=e.replace("{","[").replace("}","]")},delete_comment:function(){var e=O[F()];return delete O[F()],e},get_comments:function(){return x(),Object.keys(O).map((function(e){return{fen:e,comment:O[e]}}))},delete_comments:function(){return x(),Object.keys(O).map((function(e){var r=O[e];return delete O[e],{fen:e,comment:r}}))}}},_={q:9,r:5,b:3,n:3,p:1,k:0};function P(e){return String.fromCharCode(97+e%8)+(8-Math.floor(e/8))}function k(e,r,t){if(t!=e.turn()){const r=T(e.fen());e=S(r)}let n=0;const o=e.get(r);if(null==o)return 0;if(o.color==t)return 0;const[a,i]=function(e,r,t){const n=e.get(r);if(n&&n.color===t)return[-1,-1];const o=function(e,r,t){const n=e.moves({verbose:!0});var o=[];for(const e of n)e.to==t&&o.push(e.from);return o}(e,0,r);let a=null,i=-1;for(const r of o){const t=e.get(r).type;(null===a||R(t)<R(a))&&(a=t,i=r)}return[a,i]}(e,r,t),s=o.type;return a&&s&&(function(e,r){e.move({from:r.substring(0,2),to:r.substring(2,4)})}(e,`${i}${r}`),n=Math.max(0,R(s)-k(e,r,function(e){return"w"===e?"b":"w"}(t))),function(e){e.undo()}(e)),n}function R(e){const r=e.toLowerCase();return _[r]}function T(e){var r=e.split(" ");return"w"==r[1]?r[1]="b":r[1]="w",r.join(" ")}function M(e){return e.split(" ")[1]}function L(e,r){let t=0;M(e)!=r&&(e=T(e));for(let n=0;n<64;n++)t=Math.max(t,D(e,P(n),r));return t}function D(e,r,t){return k(S(e),r,t)}function N(e,r){const t=S();t.load(e);let n=0;for(let e=0;e<64;e++){const o=P(e),a=t.get(o);null!==a&&a.color===r&&(n+=R(a.type))}return n}class O{constructor(){chrome.runtime.onMessage.addListener((e=>{if("MemoryHandlerSet"==e.type){var r=e.message.key,t=e.message.value;this.setData(r,t)}if("MemoryHandlerGet"==e.type){r=e.message;const t=this.getData(r);console.log(t)}})),console.log("Memory Hanlder Initialized")}async setData(e,r){console.log("Setting some data",e,r);var t={};t[e]=r,await chrome.storage.local.set(t),chrome.runtime.sendMessage({type:"MemoryHandler",status:"ok"})}async getData(e){console.log("Getting some data",e);var r=[e];return(await chrome.storage.local.get(r))[e]}}new class{constructor(){this.gameAnalysis=[],this.analysisArray=[],this.stopped=!1,this.running=!1,this.waitingForStockfish=!1,this.memoryHandler=new O,this.stockfishReady=!1,this.moveQueue=[],this.analysisBlocked=!1,this.analyzedMoves=[],chrome.runtime.onMessage.addListener((e=>{"stockfishToAnalysis"==e.type&&this.sendEval(e.message),"analyzeMoves"==e.type&&this.analyzeMoveArray(e.message.moves,e.message.gameId,e.message.playerSide),"fromContentScript"==e.type&&console.log("IPAK SE OKRECE"),"stockfish"==e.type&&"readyok"==e.message&&(this.stockfishReady=!0)})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e&&e.url&&this.stopExtensionIfOnWebsite(e.url)}))})),chrome.tabs.onUpdated.addListener(((e,r,t)=>{t.active&&this.stopExtensionIfOnWebsite(t.url)})),this.analyzeMovesThread()}stopExtensionIfOnWebsite(e){console.log("compairing urls",e,this.gameId),this.gameId&&e!=this.gameId?(console.log("gonna block",e,this.gameId),this.analysisBlocked=!0):(console.log("not gonna block",e,this.gameId),this.analysisBlocked=!1)}clearData(){this.gameAnalysis=[],this.analysisArray=[]}async hasDocument(){const e=await clients.matchAll({includeUncontrolled:!0,type:"window"});for(const r of e)if(r.url.endsWith("offscreen.html"))return!0;return!1}async waitUntilStockfishReady(){for(;0==this.stockfishReady;)console.log("stockfish is not readyy"),chrome.runtime.sendMessage({type:"move array",message:"isready"}),await new Promise((e=>setTimeout(e,500)))}async setupStockfish(){await this.hasDocument()||await chrome.offscreen.createDocument({url:"./offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS||chrome.offscreen.Reason.IFRAME_SCRIPTING],justification:"need to spawn web worker for stockfish"})}async setupIfNeededAndSendMessage(e){await this.setupStockfish(),await this.waitUntilStockfishReady(e.gameId),this.stockfishReady=!1,console.log("spreman"),chrome.runtime.sendMessage(e),await new Promise((e=>setTimeout(e,500)))}async analyzeMovesThread(){for(;;)if(await new Promise((e=>setTimeout(e,200))),!this.analysisBlocked&&this.moveQueue.length>0){var{fen:e,move:r,index:t}=this.moveQueue.shift();console.log("popped from queue ",e,r,t,{fen:e,move:r,index:t,gameId:this.gameId}),await this.setupIfNeededAndSendMessage({type:"move array",message:{fen:e,move:r,index:t,gameId:this.gameId}})}}async clearDataIfNewGame(e){var r;if((r=(await chrome.storage.local.get(["currentGameId"])).currentGameId)!=e){this.gameId=e;try{await chrome.offscreen.closeDocument()}catch(e){console.log(e)}await this.setupStockfish(),this.analyzedMoves=[],this.moveQueue=[],this.gameAnalysis=[],this.analysisArray=[],this.totalMoveArray=[],this.totalFenArray=[],console.log("IDEVI NISU ISTI",r,e),await chrome.storage.local.set({currentGameId:e}),await chrome.storage.local.set({analysisData:[]}),await chrome.storage.local.set({movearray:[]}),await chrome.storage.local.set({fenarray:[]}),await chrome.storage.local.set({analyzedFens:[]}),console.log("sve ocisceno, navodno")}}returnNewMoves(e){const r=this.analyzedMoves,t=Array.from(e.slice(r.length));console.log(r.length,"oldvsnew",r.toString(),"|",e.toString(),"|",t.toString());for(const e of t)this.analyzedMoves.push(e);return t}async analyzeMoveArray(e,r,t){var n;await this.clearDataIfNewGame(r),this.playerSide=t,n=this.totalFenArray?this.totalFenArray.length:0,this.totalMoveArray=function(e){const r=new S;for(const t of e)r.move(t);var t=r.history({verbose:!0});return t.forEach(((e,r)=>{e.fromto=e.from+e.to})),t}(e),this.totalFenArray=function(e){const r=new S,t=[];t.push(r.fen());for(const n of e)r.move(n),t.push(r.fen());return t}(e),chrome.storage.local.set({moveArray:this.totalMoveArray}),chrome.storage.local.set({fenArray:this.totalFenArray}),chrome.storage.local.set({playerSide:this.playerSide});for(let e=n;e<this.totalFenArray.length;e++)0==e?this.moveQueue.push({fen:this.totalFenArray[e],move:"",index:e}):this.moveQueue.push({fen:this.totalFenArray[e],move:this.totalMoveArray[e-1].fromto,index:e})}calculateMoveBrilliance(e,r){if(r<2)return"gray";const t=r%2,n=this.analysisArray[this.analysisArray.length-2],o=this.analysisArray[this.analysisArray.length-1];if(console.log(this.analysisArray),!(1 in n))return"gray";const a=(o[0].CPreal-n[0].CPreal)*(t?1:-1);if(this.analysisArray.length>2){const r=this.analysisArray[this.analysisArray.length-3];if(a>-75&&(Math.abs(o[0].CPreal)<75||1==t&&o[0].CPreal>0||0==t&&o[0].CPreal<0)&&function(e,r,t,n){if(function(e){const r=S(e);return!(!r.in_check()||1!=r.moves.length)}(r))return!1;const o=M(e),a=N(e,o)-N(t,o),i=L(t,o),s=L(e,o);return D(r,n.substring(0,2),o)+1+a<D(t,n.substring(2,4),o)||(a?0<i-s-a:1<i-s-a)}(r[0].FEN,n[0].FEN,o[0].FEN,e))return"brilliant"}return e==n[0].move?Math.abs(Math.abs(n[0].CPreal)-Math.abs(n[1].CPreal))>100?"great":"best":e==n[1].move&&Math.abs(Math.abs(n[0].CPreal)-Math.abs(n[1].CPreal))<100?"good":a<-300?"blunder":a<-200?"mistake":a<-100?"inaccuracy":"gray"}async sendEval(e){if(this.stopped)return;var r=e.gameId;if(console.log(r,"gameId in sendEval",e.FENstring),r!=this.gameId)return;console.log("");var t=e.positionEvaluation,n=(e.FENstring,e.regularMove),o=e.moveIndex;const a={},i=t[0].CP;if("mate"==t[0].cpOrMate)if(1==t[0].isCheckmated)a.CP="M0",a.evaluation=49*-i,t[0].CPreal=2e3*-i;else{const e=i>0?1:-1;a.CP="M"+i.toString(),a.evaluation=49*e,t[0].CPreal=2e3*e}else{var s=50*(2/(1+Math.exp(-.004*i))-1);a.evaluation=s,a.CP=i,t[0].CPreal=i}this.analysisArray.push(t),a.moveRating=this.calculateMoveBrilliance(n,o),this.gameAnalysis.push(a),console.log("gotova analiza",this.gameAnalysis),await chrome.storage.local.set({analyzedFens:this.analysisArray}),await chrome.storage.local.set({analysisData:this.gameAnalysis}),chrome.storage.local.get(["analysisData"]).then((e=>{console.log("Value currently is "+e.analysisData)}))}async stopAnalysis(){if(0!=this.running){for(this.stopped=!0;this.stopped;)console.log("Cekam"),await new Promise((e=>setTimeout(e,100)));this.clearData(),console.log("stopped and started new")}}}})();