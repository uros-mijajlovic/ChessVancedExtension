(()=>{"use strict";const e="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",t=["1-0","0-1","1/2-1/2","*"],r={b:[16,32,17,15],w:[-16,-32,-17,-15]},n={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},o=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],a=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],i={p:0,n:1,b:2,r:3,q:4,k:5},s={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},l={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},u={w:[{square:l.a1,flag:s.QSIDE_CASTLE},{square:l.h1,flag:s.KSIDE_CASTLE}],b:[{square:l.a8,flag:s.QSIDE_CASTLE},{square:l.h8,flag:s.KSIDE_CASTLE}]};function c(e){var t=e.charAt(0);if(t>="a"&&t<="h"){if(e.match(/[a-h]\d.*[a-h]\d/))return;return A}return"o"===(t=t.toLowerCase())?S:t}function f(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function h(e){return e>>4}function p(e){return 15&e}function g(e){var t=p(e),r=h(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(r,r+1)}function v(e){return e===b?y:b}function m(e){var t=e instanceof Array?[]:{};for(var r in e)t[r]="object"==typeof r?m(e[r]):e[r];return t}function d(e){return e.replace(/^\s+|\s+$/g,"")}const y="b",b="w",E=-1,A="p",w="b",S="k",C=(function(){for(var e=[],t=l.a8;t<=l.h1;t++)136&t?t+=7:e.push(g(t))}(),{NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"}),_=function(_){var I=new Array(128),k={w:E,b:E},P=b,T={w:0,b:0},R=E,M=0,L=1,O=[],D={},N={};function q(e){void 0===e&&(e=!1),I=new Array(128),k={w:E,b:E},P=b,T={w:0,b:0},R=E,M=0,L=1,O=[],e||(D={}),N={},j(F())}function x(){for(var e=[],t={},r=function(e){e in N&&(t[e]=N[e])};O.length>0;)e.push(ne());for(r(F());e.length>0;)re(e.pop()),r(F());N=t}function Q(){U(e)}function U(e,t){void 0===t&&(t=!1);var r=e.split(/\s+/),n=r[0],o=0;if(!K(e).valid)return!1;q(t);for(var a=0;a<n.length;a++){var i=n.charAt(a);if("/"===i)o+=8;else if(-1!=="0123456789".indexOf(i))o+=parseInt(i,10);else{var u=i<"a"?b:y;z({type:i.toLowerCase(),color:u},g(o)),o++}}return P=r[1],r[2].indexOf("K")>-1&&(T.w|=s.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(T.w|=s.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(T.b|=s.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(T.b|=s.QSIDE_CASTLE),R="-"===r[3]?E:l[r[3]],M=parseInt(r[4],10),L=parseInt(r[5],10),j(F()),!0}function K(e){var t=e.split(/\s+/);if(6!==t.length)return{valid:!1,error_number:1,error:"FEN string must contain six space-delimited fields."};if(isNaN(parseInt(t[5]))||parseInt(t[5],10)<=0)return{valid:!1,error_number:2,error:"6th field (move number) must be a positive integer."};if(isNaN(parseInt(t[4]))||parseInt(t[4],10)<0)return{valid:!1,error_number:3,error:"5th field (half move counter) must be a non-negative integer."};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{valid:!1,error_number:4,error:"4th field (en-passant square) is invalid."};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(t[2]))return{valid:!1,error_number:5,error:"3rd field (castling availability) is invalid."};if(!/^(w|b)$/.test(t[1]))return{valid:!1,error_number:6,error:"2nd field (side to move) is invalid."};var r=t[0].split("/");if(8!==r.length)return{valid:!1,error_number:7,error:"1st field (piece positions) does not contain 8 '/'-delimited rows."};for(var n=0;n<r.length;n++){for(var o=0,a=!1,i=0;i<r[n].length;i++)if(isNaN(r[n][i])){if(!/^[prnbqkPRNBQK]$/.test(r[n][i]))return{valid:!1,error_number:9,error:"1st field (piece positions) is invalid [invalid piece]."};o+=1,a=!1}else{if(a)return{valid:!1,error_number:8,error:"1st field (piece positions) is invalid [consecutive numbers]."};o+=parseInt(r[n][i],10),a=!0}if(8!==o)return{valid:!1,error_number:10,error:"1st field (piece positions) is invalid [row too large]."}}return"3"==t[3][1]&&"w"==t[1]||"6"==t[3][1]&&"b"==t[1]?{valid:!1,error_number:11,error:"Illegal en-passant square"}:{valid:!0,error_number:0,error:"No errors."}}function F(){for(var e=0,t="",r=l.a8;r<=l.h1;r++){if(null==I[r])e++;else{e>0&&(t+=e,e=0);var n=I[r].color,o=I[r].type;t+=n===b?o.toUpperCase():o.toLowerCase()}r+1&136&&(e>0&&(t+=e),r!==l.h1&&(t+="/"),e=0,r+=8)}var a="";T[b]&s.KSIDE_CASTLE&&(a+="K"),T[b]&s.QSIDE_CASTLE&&(a+="Q"),T[y]&s.KSIDE_CASTLE&&(a+="k"),T[y]&s.QSIDE_CASTLE&&(a+="q"),a=a||"-";var i=R===E?"-":g(R);return[t,P,a,i,M,L].join(" ")}function $(e){for(var t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(D[e[t]]=e[t+1]);return D}function j(t){O.length>0||(t!==e?(D.SetUp="1",D.FEN=t):(delete D.SetUp,delete D.FEN))}function B(e){var t=I[l[e]];return t?{type:t.type,color:t.color}:null}function z(e,t){if(!("type"in e)||!("color"in e))return!1;if(-1==="pnbrqkPNBRQK".indexOf(e.type.toLowerCase()))return!1;if(!(t in l))return!1;var r=l[t];return(e.type!=S||k[e.color]==E||k[e.color]==r)&&(I[r]={type:e.type,color:e.color},e.type===S&&(k[e.color]=r),j(F()),!0)}function G(e,t,r,n,o){var a={color:P,from:t,to:r,flags:n,piece:e[t].type};return o&&(a.flags|=s.PROMOTION,a.promotion=o),e[r]?a.captured=e[r].type:n&s.EP_CAPTURE&&(a.captured=A),a}function W(e){function t(e,t,r,n,o){if(e[r].type!==A||0!==h(n)&&7!==h(n))t.push(G(e,r,n,o));else for(var a=["q","r",w,"n"],i=0,s=a.length;i<s;i++)t.push(G(e,r,n,o,a[i]))}var o=[],a=P,i=v(a),u={b:1,w:6},c=l.a8,f=l.h1,p=!1,g=void 0===e||!("legal"in e)||e.legal,m=void 0===e||!("piece"in e)||"string"!=typeof e.piece||e.piece.toLowerCase();if(void 0!==e&&"square"in e){if(!(e.square in l))return[];c=f=l[e.square],p=!0}for(var d=c;d<=f;d++)if(136&d)d+=7;else{var y=I[d];if(null!=y&&y.color===a)if(y.type!==A||!0!==m&&m!==A){if(!0===m||m===y.type)for(var b=0,E=n[y.type].length;b<E;b++){var C=n[y.type][b];for(_=d;!(136&(_+=C));){if(null!=I[_]){if(I[_].color===a)break;t(I,o,d,_,s.CAPTURE);break}if(t(I,o,d,_,s.NORMAL),"n"===y.type||"k"===y.type)break}}}else{var _=d+r[a][0];if(null==I[_]){t(I,o,d,_,s.NORMAL);_=d+r[a][1];u[a]===h(d)&&null==I[_]&&t(I,o,d,_,s.BIG_PAWN)}for(b=2;b<4;b++)136&(_=d+r[a][b])||(null!=I[_]&&I[_].color===i?t(I,o,d,_,s.CAPTURE):_===R&&t(I,o,d,R,s.EP_CAPTURE))}}if(!(!0!==m&&m!==S||p&&f!==k[a])){if(T[a]&s.KSIDE_CASTLE){var M=(L=k[a])+2;null!=I[L+1]||null!=I[M]||V(i,k[a])||V(i,L+1)||V(i,M)||t(I,o,k[a],M,s.KSIDE_CASTLE)}var L;if(T[a]&s.QSIDE_CASTLE)M=(L=k[a])-2,null!=I[L-1]||null!=I[L-2]||null!=I[L-3]||V(i,k[a])||V(i,L-1)||V(i,M)||t(I,o,k[a],M,s.QSIDE_CASTLE)}if(!g)return o;var O=[];for(d=0,E=o.length;d<E;d++)re(o[d]),Z(a)||O.push(o[d]),ne();return O}function H(e,t){var r="";if(e.flags&s.KSIDE_CASTLE)r="O-O";else if(e.flags&s.QSIDE_CASTLE)r="O-O-O";else{if(e.piece!==A){var n=function(e,t){for(var r=e.from,n=e.to,o=e.piece,a=0,i=0,s=0,l=0,u=t.length;l<u;l++){var c=t[l].from,f=t[l].to;o===t[l].piece&&r!==c&&n===f&&(a++,h(r)===h(c)&&i++,p(r)===p(c)&&s++)}return a>0?i>0&&s>0?g(r):s>0?g(r).charAt(1):g(r).charAt(0):""}(e,t);r+=e.piece.toUpperCase()+n}e.flags&(s.CAPTURE|s.EP_CAPTURE)&&(e.piece===A&&(r+=g(e.from)[0]),r+="x"),r+=g(e.to),e.flags&s.PROMOTION&&(r+="="+e.promotion.toUpperCase())}return re(e),J()&&(X()?r+="#":r+="+"),ne(),r}function V(e,t){for(var r=l.a8;r<=l.h1;r++)if(136&r)r+=7;else if(null!=I[r]&&I[r].color===e){var n=I[r],s=r-t,u=s+119;if(o[u]&1<<i[n.type]){if(n.type===A){if(s>0){if(n.color===b)return!0}else if(n.color===y)return!0;continue}if("n"===n.type||"k"===n.type)return!0;for(var c=a[u],f=r+c,h=!1;f!==t;){if(null!=I[f]){h=!0;break}f+=c}if(!h)return!0}}return!1}function Z(e){return V(v(e),k[e])}function J(){return Z(P)}function X(){return J()&&0===W().length}function Y(){return!J()&&0===W().length}function ee(){for(var e={},t=[],r=0,n=0,o=l.a8;o<=l.h1;o++)if(n=(n+1)%2,136&o)o+=7;else{var a=I[o];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===w&&t.push(n),r++)}if(2===r)return!0;if(3===r&&(1===e[w]||1===e.n))return!0;if(r===e[w]+2){var i=0,s=t.length;for(o=0;o<s;o++)i+=t[o];if(0===i||i===s)return!0}return!1}function te(){for(var e=[],t={},r=!1;;){var n=ne();if(!n)break;e.push(n)}for(;;){var o=F().split(" ").slice(0,4).join(" ");if(t[o]=o in t?t[o]+1:1,t[o]>=3&&(r=!0),!e.length)break;re(e.pop())}return r}function re(e){var t=P,r=v(t);if(function(e){O.push({move:e,kings:{b:k.b,w:k.w},turn:P,castling:{b:T.b,w:T.w},ep_square:R,half_moves:M,move_number:L})}(e),I[e.to]=I[e.from],I[e.from]=null,e.flags&s.EP_CAPTURE&&(P===y?I[e.to-16]=null:I[e.to+16]=null),e.flags&s.PROMOTION&&(I[e.to]={type:e.promotion,color:t}),I[e.to].type===S){if(k[I[e.to].color]=e.to,e.flags&s.KSIDE_CASTLE){var n=e.to-1,o=e.to+1;I[n]=I[o],I[o]=null}else e.flags&s.QSIDE_CASTLE&&(n=e.to+1,o=e.to-2,I[n]=I[o],I[o]=null);T[t]=""}if(T[t])for(var a=0,i=u[t].length;a<i;a++)if(e.from===u[t][a].square&&T[t]&u[t][a].flag){T[t]^=u[t][a].flag;break}if(T[r])for(a=0,i=u[r].length;a<i;a++)if(e.to===u[r][a].square&&T[r]&u[r][a].flag){T[r]^=u[r][a].flag;break}R=e.flags&s.BIG_PAWN?"b"===P?e.to-16:e.to+16:E,e.piece===A||e.flags&(s.CAPTURE|s.EP_CAPTURE)?M=0:M++,P===y&&L++,P=v(P)}function ne(){var e=O.pop();if(null==e)return null;var t=e.move;k=e.kings,P=e.turn,T=e.castling,R=e.ep_square,M=e.half_moves,L=e.move_number;var r,n,o=P,a=v(P);if(I[t.from]=I[t.to],I[t.from].type=t.piece,I[t.to]=null,t.flags&s.CAPTURE)I[t.to]={type:t.captured,color:a};else if(t.flags&s.EP_CAPTURE){var i;i=o===y?t.to-16:t.to+16,I[i]={type:A,color:a}}return t.flags&(s.KSIDE_CASTLE|s.QSIDE_CASTLE)&&(t.flags&s.KSIDE_CASTLE?(r=t.to+1,n=t.to-1):t.flags&s.QSIDE_CASTLE&&(r=t.to-2,n=t.to+1),I[r]=I[n],I[n]=null),t}function oe(e,t){for(var r=f(e),n=0;n<2;n++){if(1==n){if(!t)return null;var o=!1;if(h=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/)){var a=h[1],i=h[2],s=h[3],u=h[4];1==i.length&&(o=!0)}else{var h;(h=r.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/))&&(a=h[1],i=h[2],s=h[3],u=h[4],1==i.length&&(o=!0))}}for(var p=c(r),v=W({legal:!0,piece:a||p}),m=0,d=v.length;m<d;m++)switch(n){case 0:if(r===f(H(v[m],v)))return v[m];break;case 1:if(h){if(!(a&&a.toLowerCase()!=v[m].piece||l[i]!=v[m].from||l[s]!=v[m].to||u&&u.toLowerCase()!=v[m].promotion))return v[m];if(o){var y=g(v[m].from);if(!(a&&a.toLowerCase()!=v[m].piece||l[s]!=v[m].to||i!=y[0]&&i!=y[1]||u&&u.toLowerCase()!=v[m].promotion))return v[m]}}}}return null}function ae(e){var t=m(e);t.san=H(t,W({legal:!0})),t.to=g(t.to),t.from=g(t.from);var r="";for(var n in s)s[n]&t.flags&&(r+=C[n]);return t.flags=r,t}function ie(e){for(var t=W({legal:!1}),r=0,n=P,o=0,a=t.length;o<a;o++)re(t[o]),Z(n)||(e-1>0?r+=ie(e-1):r++),ne();return r}return U(void 0===_?e:_),{load:function(e){return U(e)},reset:function(){return Q()},swapTurn:function(){this.turn==b?this.turn=y:this.turn=b},moves:function(e){for(var t=W(e),r=[],n=0,o=t.length;n<o;n++)void 0!==e&&"verbose"in e&&e.verbose?r.push(ae(t[n])):r.push(H(t[n],W({legal:!0})));return r},in_check:function(){return J()},in_checkmate:function(){return X()},in_stalemate:function(){return Y()},in_draw:function(){return M>=100||Y()||ee()||te()},insufficient_material:function(){return ee()},in_threefold_repetition:function(){return te()},game_over:function(){return M>=100||X()||Y()||ee()||te()},validate_fen:function(e){return K(e)},fen:function(){return F()},board:function(){for(var e=[],t=[],r=l.a8;r<=l.h1;r++)null==I[r]?t.push(null):t.push({square:g(r),type:I[r].type,color:I[r].color}),r+1&136&&(e.push(t),t=[],r+=8);return e},pgn:function(e){var t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",r="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,n=[],o=!1;for(var a in D)n.push("["+a+' "'+D[a]+'"]'+t),o=!0;o&&O.length&&n.push(t);for(var i=function(e){var t=N[F()];return void 0!==t&&(e=`${e}${e.length>0?" ":""}{${t}}`),e},s=[];O.length>0;)s.push(ne());var l=[],u="";for(0===s.length&&l.push(i(""));s.length>0;){u=i(u);var c=s.pop();if(O.length||"b"!==c.color)"w"===c.color&&(u.length&&l.push(u),u=L+".");else{const e=`${L}. ...`;u=u?`${u} ${e}`:e}u=u+" "+H(c,W({legal:!0})),re(c)}if(u.length&&l.push(i(u)),void 0!==D.Result&&l.push(D.Result),0===r)return n.join("")+l.join(" ");var f=function(){return n.length>0&&" "===n[n.length-1]&&(n.pop(),!0)},h=function(e,o){for(var a of o.split(" "))if(a){if(e+a.length>r){for(;f();)e--;n.push(t),e=0}n.push(a),e+=a.length,n.push(" "),e++}return f()&&e--,e},p=0;for(a=0;a<l.length;a++)p+l[a].length>r&&l[a].includes("{")?p=h(p,l[a]):(p+l[a].length>r&&0!==a?(" "===n[n.length-1]&&n.pop(),n.push(t),p=0):0!==a&&(n.push(" "),p++),n.push(l[a]),p+=l[a].length);return n.join("")},load_pgn:function(e,r){var n=void 0!==r&&"sloppy"in r&&r.sloppy;function o(e){return e.replace(/\\/g,"\\")}e=e.trim();var a="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",i=new RegExp("^(\\[((?:"+o(a)+")|.)*\\])(?:\\s*"+o(a)+"){2}"),s=i.test(e)?i.exec(e)[1]:"";Q();var l=function(e,t){for(var r="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",n={},a=e.split(new RegExp(o(r))),i="",s="",l=0;l<a.length;l++){var u=/^\s*\[([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;i=a[l].replace(u,"$1"),s=a[l].replace(u,"$2"),d(i).length>0&&(n[i]=s)}return n}(s,r),u="";for(var c in l)"fen"===c.toLowerCase()&&(u=l[c]),$([c,l[c]]);if(n){if(u&&!U(u,!0))return!1}else if(!("1"!==l.SetUp||"FEN"in l&&U(l.FEN,!0)))return!1;for(var f=function(e){return`{${function(e){return Array.from(e).map((function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/\%/g,"").toLowerCase()})).join("")}((e=e.replace(new RegExp(o(a),"g")," ")).slice(1,e.length-1))}}`},h=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))}(e.slice(1,e.length-1))},p=e.replace(s,"").replace(new RegExp(`({[^}]*})+?|;([^${o(a)}]*)`,"g"),(function(e,t,r){return void 0!==t?f(t):" "+f(`{${r.slice(1)}}`)})).replace(new RegExp(o(a),"g")," "),g=/(\([^\(\)]+\))+?/g;g.test(p);)p=p.replace(g,"");var v=d(p=(p=(p=p.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));v=v.join(",").replace(/,,+/g,",").split(",");for(var m="",y="",b=0;b<v.length;b++){var E=h(v[b]);if(void 0===E)if(null==(m=oe(v[b],n))){if(!(t.indexOf(v[b])>-1))return!1;y=v[b]}else y="",re(m);else N[F()]=E}return y&&Object.keys(D).length&&!D.Result&&$(["Result",y]),!0},header:function(){return $(arguments)},turn:function(){return P},move:function(e,t){var r=void 0!==t&&"sloppy"in t&&t.sloppy,n=null;if("string"==typeof e)n=oe(e,r);else if("object"==typeof e)for(var o=W(),a=0,i=o.length;a<i;a++)if(e.from===g(o[a].from)&&e.to===g(o[a].to)&&(!("promotion"in o[a])||e.promotion===o[a].promotion)){n=o[a];break}if(!n)return null;var s=ae(n);return re(n),s},undo:function(){var e=ne();return e?ae(e):null},clear:function(){return q()},put:function(e,t){return z(e,t)},get:function(e){return B(e)},ascii(){for(var e="   +------------------------+\n",t=l.a8;t<=l.h1;t++){if(0===p(t)&&(e+=" "+"87654321"[h(t)]+" |"),null==I[t])e+=" . ";else{var r=I[t].type;e+=" "+(I[t].color===b?r.toUpperCase():r.toLowerCase())+" "}t+1&136&&(e+="|\n",t+=8)}return(e+="   +------------------------+\n")+"     a  b  c  d  e  f  g  h"},remove:function(e){return function(e){var t=B(e);return I[l[e]]=null,t&&t.type===S&&(k[t.color]=E),j(F()),t}(e)},perft:function(e){return ie(e)},square_color:function(e){if(e in l){var t=l[e];return(h(t)+p(t))%2==0?"light":"dark"}return null},history:function(e){for(var t=[],r=[],n=(void 0!==e&&"verbose"in e&&e.verbose);O.length>0;)t.push(ne());for(;t.length>0;){var o=t.pop();n?r.push(ae(o)):r.push(H(o,W({legal:!0}))),re(o)}return r},get_comment:function(){return N[F()]},set_comment:function(e){N[F()]=e.replace("{","[").replace("}","]")},delete_comment:function(){var e=N[F()];return delete N[F()],e},get_comments:function(){return x(),Object.keys(N).map((function(e){return{fen:e,comment:N[e]}}))},delete_comments:function(){return x(),Object.keys(N).map((function(e){var t=N[e];return delete N[e],{fen:e,comment:t}}))}}},I={q:9,r:5,b:3,n:3,p:1,k:0};function k(e){return String.fromCharCode(97+e%8)+(8-Math.floor(e/8))}function P(e,t,r){if(r!=e.turn()){const t=R(e.fen());e=_(t)}let n=0;const o=e.get(t);if(null==o)return 0;if(o.color==r)return 0;const[a,i]=function(e,t,r){const n=e.get(t);if(n&&n.color===r)return[-1,-1];const o=function(e,t,r){const n=e.moves({verbose:!0});var o=[];for(const e of n)e.to==r&&o.push(e.from);return o}(e,0,t);let a=null,i=-1;for(const t of o){const r=e.get(t).type;(null===a||T(r)<T(a))&&(a=r,i=t)}return[a,i]}(e,t,r),s=o.type;return a&&s&&(function(e,t){e.move({from:t.substring(0,2),to:t.substring(2,4)})}(e,`${i}${t}`),n=Math.max(0,T(s)-P(e,t,function(e){return"w"===e?"b":"w"}(r))),function(e){e.undo()}(e)),n}function T(e){const t=e.toLowerCase();return I[t]}function R(e){var t=e.split(" ");return"w"==t[1]?t[1]="b":t[1]="w",t.join(" ")}function M(e){return e.split(" ")[1]}function L(e,t){let r=0;M(e)!=t&&(e=R(e));for(let n=0;n<64;n++)r=Math.max(r,O(e,k(n),t));return r}function O(e,t,r){return P(_(e),t,r)}function D(e,t){const r=_();r.load(e);let n=0;for(let e=0;e<64;e++){const o=k(e),a=r.get(o);null!==a&&a.color===t&&(n+=T(a.type))}return n}class N{constructor(){chrome.runtime.onMessage.addListener((e=>{if("MemoryHandlerSet"==e.type){var t=e.message.key,r=e.message.value;this.setData(t,r)}if("MemoryHandlerGet"==e.type){t=e.message;const r=this.getData(t);console.log(r)}})),console.log("Memory Hanlder Initialized")}async setData(e,t){console.log("Setting some data",e,t);var r={};r[e]=t,await chrome.storage.local.set(r),chrome.runtime.sendMessage({type:"MemoryHandler",status:"ok"})}async getData(e){console.log("Getting some data",e);var t=[e];return(await chrome.storage.local.get(t))[e]}}new class{constructor(){this.gameAnalysis=[],this.analysisArray=[],this.stopped=!1,this.running=!1,this.waitingForStockfish=!1,this.currentGameId=null,this.memoryHandler=new N,this.stockfishReady=!1,this.moveQueue=[],this.analysisBlocked=!1,this.analyzedMoves=[],chrome.runtime.onMessage.addListener((e=>{"stockfishToAnalysis"==e.type&&this.sendEval(e.message),"analyzeMoves"==e.type&&this.analyzeMoveArray(e.message.moves,e.message.gameId,e.message.playerSide),"fromContentScript"==e.type&&console.log("IPAK SE OKRECE"),"stockfish"==e.type&&"readyok"==e.message&&(this.stockfishReady=!0)})),chrome.tabs.onActivated.addListener((e=>{chrome.tabs.get(e.tabId,(e=>{e&&e.url&&this.stopExtensionIfOnWebsite(e.url)}))})),chrome.tabs.onUpdated.addListener(((e,t,r)=>{r.active&&this.stopExtensionIfOnWebsite(r.url)})),this.analyzeMovesThread()}stopExtensionIfOnWebsite(e){this.analysisBlocked="https://chessvanced.com/"==e}clearData(){this.gameAnalysis=[],this.analysisArray=[]}async hasDocument(){const e=await clients.matchAll({includeUncontrolled:!0,type:"window"});for(const t of e)if(t.url.endsWith("offscreen.html"))return!0;return!1}async waitUntilStockfishReady(){for(;0==this.stockfishReady;)console.log("stockfish is not readyy"),chrome.runtime.sendMessage({type:"move array",message:"isready"}),await new Promise((e=>setTimeout(e,500)))}async setupStockfish(){await this.hasDocument()||await chrome.offscreen.createDocument({url:"./offscreen/offscreen.html",reasons:[chrome.offscreen.Reason.WORKERS],justification:"need to spawn web worker for stockfish"})}async setupIfNeededAndSendMessage(e){await this.setupStockfish(),await this.waitUntilStockfishReady(e.gameId),this.stockfishReady=!1,console.log("spreman"),chrome.runtime.sendMessage(e),await new Promise((e=>setTimeout(e,500)))}async analyzeMovesThread(){for(;;)if(await new Promise((e=>setTimeout(e,200))),!this.analysisBlocked&&this.moveQueue.length>0){var{fen:e,move:t,index:r}=this.moveQueue.shift();console.log("popped from queue ",e,t,r,{fen:e,move:t,index:r,gameId:this.gameId}),await this.setupIfNeededAndSendMessage({type:"move array",message:{fen:e,move:t,index:r,gameId:this.gameId}})}}async clearDataIfNewGame(e){var t;if((t=(await chrome.storage.local.get(["currentGameId"])).currentGameId)!=e){this.gameId=e;try{await chrome.offscreen.closeDocument()}catch(e){console.log(e)}await this.setupStockfish(),this.analyzedMoves=[],this.moveQueue=[],this.gameAnalysis=[],this.analysisArray=[],this.totalMoveArray=[],this.totalFenArray=[],console.log("IDEVI NISU ISTI",t,e),await chrome.storage.local.set({currentGameId:e}),await chrome.storage.local.set({analysisData:[]}),await chrome.storage.local.set({movearray:[]}),await chrome.storage.local.set({fenarray:[]}),await chrome.storage.local.set({analyzedFens:[]}),console.log("sve ocisceno, navodno")}}returnNewMoves(e){const t=this.analyzedMoves,r=Array.from(e.slice(t.length));console.log(t.length,"oldvsnew",t.toString(),"|",e.toString(),"|",r.toString());for(const e of r)this.analyzedMoves.push(e);return r}async analyzeMoveArray(e,t,r){var n;await this.clearDataIfNewGame(t),this.playerSide=r,n=this.totalFenArray?this.totalFenArray.length:0,this.totalMoveArray=function(e){const t=new _;for(const r of e)t.move(r);var r=t.history({verbose:!0});return r.forEach(((e,t)=>{e.fromto=e.from+e.to})),r}(e),this.totalFenArray=function(e){const t=new _,r=[];r.push(t.fen());for(const n of e)t.move(n),r.push(t.fen());return r}(e),chrome.storage.local.set({moveArray:this.totalMoveArray}),chrome.storage.local.set({fenArray:this.totalFenArray}),chrome.storage.local.set({playerSide:this.playerSide});for(let e=n;e<this.totalFenArray.length;e++)0==e?this.moveQueue.push({fen:this.totalFenArray[e],move:"",index:e}):this.moveQueue.push({fen:this.totalFenArray[e],move:this.totalMoveArray[e-1].fromto,index:e})}calculateMoveBrilliance(e,t){if(t<2)return"gray";const r=t%2,n=this.analysisArray[this.analysisArray.length-2],o=this.analysisArray[this.analysisArray.length-1];if(!(1 in n))return"gray";const a=(o[0].CP-n[0].CP)*(r?1:-1);if(this.analysisArray.length>2){const t=this.analysisArray[this.analysisArray.length-3];if(a>-75&&(Math.abs(o[0].CP)<75||1==r&&o[0].CP>0||0==r&&o[0].CP<0)&&function(e,t,r,n){if(function(e){const t=_(e);return!(!t.in_check()||1!=t.moves.length)}(t))return!1;const o=M(e),a=D(e,o)-D(r,o),i=L(r,o),s=L(e,o);return O(t,n.substring(0,2),o)+1+a<O(r,n.substring(2,4),o)||(a?0<i-s-a:1<i-s-a)}(t[0].FEN,n[0].FEN,o[0].FEN,e))return"brilliant"}return e==n[0].move?Math.abs(Math.abs(n[0].CP)-Math.abs(n[1].CP))>100?"great":"best":e==n[1].move&&Math.abs(Math.abs(n[0].CP)-Math.abs(n[1].CP))<100?"good":a<-200?"mistake":"gray"}async sendEval(e){if(this.stopped)return;var t=e.gameId;if(console.log(t,"gameId in sendEval",e.FENstring),t!=this.gameId)return;console.log("");var r=e.positionEvaluation,n=(e.FENstring,e.regularMove),o=e.moveIndex;this.analysisArray.push(r);const a={},i=r[0].CP;if("mate"==r[0].cpOrMate)if(1==r[0].isCheckmated)a.CP="M0",a.evaluation=49*-i;else{const e=i>0?1:-1;a.CP="M"+i.toString(),a.evaluation=49*e}else{var s=50*(2/(1+Math.exp(-.004*i))-1);a.evaluation=s,a.CP=i}a.moveRating=this.calculateMoveBrilliance(n,o),this.gameAnalysis.push(a),console.log("gotova analiza",this.gameAnalysis),await chrome.storage.local.set({analyzedFens:this.analysisArray}),await chrome.storage.local.set({analysisData:this.gameAnalysis}),chrome.storage.local.get(["analysisData"]).then((e=>{console.log("Value currently is "+e.analysisData)}))}async stopAnalysis(){if(0!=this.running){for(this.stopped=!0;this.stopped;)console.log("Cekam"),await new Promise((e=>setTimeout(e,100)));this.clearData(),console.log("stopped and started new")}}async updateData(e,t,r){this.currentGameId!=r&&(await restartStockfishOrchestrator(),this.currentGameId=r),this.analyzeGame(e,t)}async restartStockfishOrchestrator(){this.stockfishOrchestrator&&this.stockfishOrchestrator.deleteWorker(),await this.stopAnalysis(),this.stockfishOrchestrator=await createStockfishOrchestrator(!1),this.stockfishOrchestrator.analysisOrchestrator=this,this.stockfishOrchestrator.setCallback((e=>{this.sendEval(e)}))}}})();